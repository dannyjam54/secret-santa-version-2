<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Secret Santa Shareable App</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #a3d5f7;
      margin: 0;
      min-height: 100vh;
      overflow-y: scroll;
    }

    .snowflake {
      position: fixed;
      top: -10px;
      color: white;
      font-size: 1em;
      pointer-events: none;
      user-select: none;
      animation-name: snow;
      animation-timing-function: linear;
      animation-iteration-count: infinite;
    }

    @keyframes snow {
      0% { transform: translateY(0); }
      100% { transform: translateY(100vh); }
    }

    .container {
      max-width: 500px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      border: 3px solid #b71c1c;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .result {
      background: #fff3e0;
      color: #4e342e;
      border-left: 6px solid #c62828;
      padding: 12px;
      margin-top: 12px;
      border-radius: 10px;
      white-space: pre-wrap;
      visibility: hidden;
      height: 0;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    .result.show { visibility: visible; height: auto; }

    #adminPanel {
      display: none;
      margin-top: 20px;
      padding: 12px;
      background: #fff9d6;
      border-radius: 10px;
      border: 1px solid #ccc;
    }

    #nameList {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 10px;
    }

    input[type="text"] {
      width: 95%;
      padding: 8px;
      font-size: 16px;
      border: 2px solid #b71c1c;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    button {
      width: 100%;
      padding: 12px;
      font-size: 18px;
      border-radius: 8px;
      border: none;
      margin-top: 10px;
      cursor: pointer;
    }

    #drawBtn { background: #2e7d32; color: white; }
    #resetBtn { background: #c62828; color: white; display: none; }
    #addNameBtn { background: #0277bd; color: white; }
    #saveNamesBtn { background: #6a1b9a; color: white; }
  </style>
</head>

<body>
  <div class="container">
    <h2>Secret Santa — Draw Your Recipient</h2>

    <label>Your Name:</label>
    <input type="text" id="drawerName" placeholder="Enter your name" />

    <button id="drawBtn">Draw</button>
    <button id="resetBtn">Reset</button>

    <div id="result" class="result"></div>

    <!-- ADMIN PANEL -->
    <div id="adminPanel">
      <h3>Edit Participants</h3>

      <div id="nameList"></div>

      <button id="addNameBtn">Add Name</button>
      <button id="saveNamesBtn">Save Names</button>
      <p id="adminMsg" style="color: green;"></p>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const INITIAL_PEOPLE = ["Rob","Tilly","Sarah","Harry","Dan","Kelly","Neve","Erin"];
  let assignments = {};
  const usedDrawers = new Set();
  const MAX_PARTICIPANTS = 100;
  let families = {};

  const drawerInput = document.getElementById('drawerName');
  const resultBox = document.getElementById('result');
  const resetBtn   = document.getElementById('resetBtn');

  function normalizeName(s) { return s.trim().toLowerCase(); }

  function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function generateDerangement(names) {
    for (let attempts = 0; attempts < 1000; attempts++) {
      const receivers = shuffle(names);
      let valid = true;

      for (let i = 0; i < names.length; i++) {
        const giver = names[i];
        const receiver = receivers[i];

        if (normalizeName(giver) === normalizeName(receiver)) valid = false;
        if (families[giver] && families[giver] === families[receiver]) valid = false;

        if (!valid) break;
      }

      if (valid) return receivers;
    }
    return names.map((n,i) => names[(i+1) % names.length]);
  }

  function saveAll() {
    localStorage.setItem("ssPeople", JSON.stringify(INITIAL_PEOPLE));
    localStorage.setItem("ssFamilies", JSON.stringify(families));
    localStorage.setItem("ssAssignments", JSON.stringify(assignments));
  }

  function initAssignments() {
    const savedPeople      = localStorage.getItem("ssPeople");
    const savedFamilies    = localStorage.getItem("ssFamilies");
    const savedAssignments = localStorage.getItem("ssAssignments");

    if (savedPeople && savedAssignments) {
      INITIAL_PEOPLE.length = 0;
      INITIAL_PEOPLE.push(...JSON.parse(savedPeople));
      families = savedFamilies ? JSON.parse(savedFamilies) : {};
      assignments = JSON.parse(savedAssignments);
      return;
    }

    const receivers = generateDerangement(INITIAL_PEOPLE);
    assignments = {};

    for (let i = 0; i < INITIAL_PEOPLE.length; i++) {
      assignments[normalizeName(INITIAL_PEOPLE[i])] = receivers[i];
    }

    saveAll();
  }

  function showMessage(msg, isError=false) {
    resultBox.textContent = msg;
    resultBox.style.borderLeft = isError ? "6px solid red" : "6px solid green";
    resultBox.classList.add('show');
  }

  function drawName() {
    let name = drawerInput.value.trim();
    if (!name) return showMessage("Please enter your name.", true);

    const norm = normalizeName(name);

    if (norm === "admin") return showAdminPanel();
    if (norm === "log")   return showLog();
    if (norm === "cabbage") { resetBtn.style.display = "block"; return; }

    const normList = INITIAL_PEOPLE.map(p => normalizeName(p));
    if (!normList.includes(norm)) return showMessage("Name not recognized.", true);

    if (usedDrawers.has(norm))
      return showMessage("You already viewed your assignment.", true);

    usedDrawers.add(norm);
    saveAll();

    showMessage(`Hi ${name}, you give to: ${assignments[norm]}`);
  }

  function resetAll() {
    localStorage.clear();
    usedDrawers.clear();
    drawerInput.value = "";
    resultBox.classList.remove("show");
    resultBox.textContent = "";
    resetBtn.style.display = "none";

    assignments = {};
    families = {};
    INITIAL_PEOPLE.length = 0;
    INITIAL_PEOPLE.push("Rob","Tilly","Sarah","Harry","Dan","Kelly","Neve","Erin");

    initAssignments();
  }

  function showLog() {
    let out = "Secret Santa Assignments:\n\n";
    for (const [giver, rec] of Object.entries(assignments)) {
      out += `${giver} → ${rec}\n`;
    }
    showMessage(out);
  }

  function showAdminPanel() {
    const panel = document.getElementById("adminPanel");
    const list  = document.getElementById("nameList");
    panel.style.display = "block";
    list.innerHTML = "";

    INITIAL_PEOPLE.forEach(name => {
      const row = document.createElement("div");

      const input = document.createElement("input");
      input.value = name;
      input.className = "participant-name";

      const fam = document.createElement("input");
      fam.placeholder = "Family (optional)";
      fam.value = families[name] || "";
      fam.className = "participant-family";

      row.appendChild(input);
      row.appendChild(fam);
      list.appendChild(row);
    });
  }

  function addNameField() {
    const list = document.getElementById("nameList");
    const row = document.createElement("div");

    const input = document.createElement("input");
    input.placeholder = "New Name";
    input.className = "participant-name";

    const fam = document.createElement("input");
    fam.placeholder = "Family";
    fam.className = "participant-family";

    row.appendChild(input);
    row.appendChild(fam);
    list.appendChild(row);
  }

  function saveNames() {
    const inputs = document.querySelectorAll(".participant-name");
    const fams   = document.querySelectorAll(".participant-family");

    INITIAL_PEOPLE.length = 0;
    families = {};

    inputs.forEach((el, i) => {
      const name = el.value.trim();
      const fam  = fams[i].value.trim();
      if (!name) return;
      INITIAL_PEOPLE.push(name);
      if (fam) families[name] = fam;
    });

    const receivers = generateDerangement(INITIAL_PEOPLE);
    assignments = {};

    for (let i = 0; i < INITIAL_PEOPLE.length; i++) {
      assignments[normalizeName(INITIAL_PEOPLE[i])] = receivers[i];
    }

    saveAll();
    document.getElementById("adminPanel").style.display = "none";
  }

  document.getElementById("drawBtn").onclick = drawName;
  document.getElementById("resetBtn").onclick = resetAll;
  document.getElementById("addNameBtn").onclick = addNameField;
  document.getElementById("saveNamesBtn").onclick = saveNames;

  initAssignments();

  const snowflakes = 60;
  for (let i = 0; i < snowflakes; i++) {
    const flake = document.createElement("div");
    flake.className = "snowflake";
    flake.textContent = "❄";
    flake.style.left = Math.random() * 100 + "vw";
    flake.style.fontSize = Math.random() * 24 + 10 + "px";
    flake.style.animationDuration = (Math.random() * 10 + 6) + "s";
    flake.style.opacity = Math.random();
    document.body.appendChild(flake);
  }

});
</script>

</body>
</html>
