<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Secret Santa Shareable App</title>
  <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #a3d5f7; /* light blue background */
      overflow-y: scroll; /* always show scrollbar to prevent jumps */
      margin: 0;
      position: relative;
      min-height: 100vh;
    }

    .snowflake {
      position: absolute;
      top: -10px;
      color: white;
      font-size: 1em;
      user-select: none;
      pointer-events: none;
      animation-name: snow;
      animation-iteration-count: infinite;
      animation-timing-function: linear;
    }

    @keyframes snow {
      0% { transform: translateY(0); }
      100% { transform: translateY(100vh); }
    }

    .container {
      max-width: 480px;
      margin: auto;
      background: #fff8f0;
      padding: 20px;
      border-radius: 12px;
      border: 3px solid #d32f2f;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: box-shadow 0.3s ease;
    }

    .container:hover {
      box-shadow: 0 6px 16px rgba(0,0,0,0.35);
    }

    h2 {
      font-family: 'Mountains of Christmas', cursive;
      color: #b71c1c;
      text-align: center;
      text-shadow: 1px 1px 2px #fff;
    }

    .result {
      background: #fff3e0;
      color: #4e342e;
      border-left: 6px solid #c62828;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      font-size: 18px;
      white-space: pre-wrap;
      margin-top: 10px;
      visibility: hidden;
      height: 0;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .result.show {
      visibility: visible;
      height: auto;
    }

    button {
      border-radius: 10px;
      font-size: 18px;
      padding: 12px;
      border: 2px solid #2e7d32; /* same border width on hover */
      color: #fff;
      cursor: pointer;
      background: #2e7d32;
      transition: all 0.3s ease;
    }

    button:hover {
      background: #66bb6a;
      box-shadow: 0 0 10px #ffeb3b;
    }

    #resetBtn {
      background: #c62828;
      border: 2px solid #c62828;
    }

    #resetBtn:hover {
      background: #ef5350;
      box-shadow: 0 0 10px #ffeb3b;
    }

    input[type="text"] {
      width: 48%;
      padding: 8px;
      font-size: 16px;
      border-radius: 8px;
      border: 2px solid #d32f2f;
      margin-bottom: 4px;
      outline: none; /* remove default outline */
      box-sizing: border-box; /* prevent size changes */
      transition: box-shadow 0.2s ease;
    }

    input[type="text"]:focus {
      box-shadow: 0 0 5px #ffeb3b; /* highlight without shifting */
      border-color: #d32f2f; /* same width to prevent jump */
    }

    .row { display: flex; gap: 8px; margin-top: 10px; }
    .small { width: 48%; }
    .muted { color: #4e342e; font-size: 13px; }

    /* Admin Panel */
    #adminPanel {
      display: none; /* hidden by default */
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 10px;
      background: #fffbe6;
      flex-direction: column;
    }

    #nameList {
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-height: 400px; /* allow scrolling for many participants */
      overflow-y: auto;
    }

    #adminButtons {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Secret Santa — Draw Your Recipient</h2>
    <p class="muted">Enter your first name exactly as listed or use the link sent to you to see your draw. Only you will see your assignment.</p>

    <label for="drawerName">Your Name</label>
    <input type="text" id="drawerName" placeholder="e.g. Rob" autocomplete="off" />

    <div class="row">
      <div class="small"><button id="drawBtn" onclick="drawName()">Draw</button></div>
      <div class="small"><button id="resetBtn" onclick="resetAll()" style="background:#f44336; display:none;">Reset</button></div>
    </div>

    <div id="result" class="result"></div>

    <!-- Admin Panel -->
    <div id="adminPanel">
      <h3>Admin Panel — Edit Participants</h3>
      <div id="nameList"></div>
      <div id="adminButtons">
        <button id="addNameBtn">Add Name</button>
        <button id="saveNamesBtn">Save Names</button>
      </div>
      <p id="adminMsg" style="color:green;"></p>
    </div>
  </div>

  <script>
    const INITIAL_PEOPLE = ["Rob","Tilly","Sarah","Harry","Dan","Kelly","Neve","Erin"];
    let assignments = {};
    const usedDrawers = new Set();
    const MAX_PARTICIPANTS = 100;
    let families = {};

    const resultBox = document.getElementById('result');
    const drawerInput = document.getElementById('drawerName');
    const resetBtn = document.getElementById('resetBtn');

    function normalizeName(s) { return s.trim().toLowerCase(); }

    function shuffle(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function generateDerangement(names) {
      const maxAttempts = 1000;
      for (let attempt = 0; attempt < maxAttempts; attempt++) {
        const receivers = shuffle(names);
        let valid = true;
        for (let i = 0; i < names.length; i++) {
          const giver = names[i];
          const receiver = receivers[i];
          if (normalizeName(giver) === normalizeName(receiver) ||
              (families[giver] && families[giver] === families[receiver])) {
            valid = false;
            break;
          }
        }
        if (valid) return receivers;
      }
      return names.map((n,i) => names[(i+1)%names.length]);
    }

    function initAssignments() {
      const receivers = generateDerangement(INITIAL_PEOPLE);
      for (let i=0;i<INITIAL_PEOPLE.length;i++) {
        assignments[normalizeName(INITIAL_PEOPLE[i])] = receivers[i];
      }
    }

    function showMessage(msg, isError=false) {
      if (!resultBox) return;
      resultBox.textContent = msg;
      resultBox.style.borderLeft = isError ? '6px solid #f44336' : '6px solid #4CAF50';
      resultBox.classList.add('show');
    }

    function drawName() {
      let drawer = drawerInput.value.trim();
      if (!drawer) { showMessage('Please enter your name.', true); return; }

      const drawerNorm = normalizeName(drawer);

      if (drawerNorm === 'admin') { showAdminPanel(); return; }
      if (drawerNorm === 'log') {
        let logText = 'Secret Santa Assignments:\n';
        for (const [giver, recipient] of Object.entries(assignments)) {
          logText += `${giver} → ${recipient}\n`;
        }
        showMessage(logText); return;
      }

      if (drawerNorm === 'cabbage' && resetBtn) resetBtn.style.display = 'block';

      const participantNorms = INITIAL_PEOPLE.map(p => normalizeName(p));
      if (!participantNorms.includes(drawerNorm)) { showMessage('Name not recognized.', true); return; }
      if (usedDrawers.has(drawerNorm)) { showMessage('You have already drawn.', true); return; }

      const recipient = assignments[drawerNorm];
      usedDrawers.add(drawerNorm);
      showMessage(`Hi ${drawer}, you will give a gift to: ${recipient}`);
    }

    function resetAll() {
      assignments = {};
      usedDrawers.clear();
      if (drawerInput) drawerInput.value = '';
      if (resultBox) { resultBox.classList.remove('show'); resultBox.textContent = ''; resultBox.style.borderLeft = ''; }
      if (resetBtn) resetBtn.style.display = 'none';
      initAssignments();
    }

    function showAdminPanel() {
      const panel = document.getElementById('adminPanel');
      panel.style.display = 'flex';

      const listDiv = document.getElementById('nameList');
      listDiv.innerHTML = '';

      INITIAL_PEOPLE.forEach((name, i) => {
        const row = document.createElement('div');
        row.className = 'participant-row';

        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.value = name;
        nameInput.className = 'participant-name';

        const familyInput = document.createElement('input');
        familyInput.type = 'text';
        familyInput.placeholder = 'Family (optional)';
        familyInput.className = 'participant-family';
        familyInput.value = families[name] || '';

        row.appendChild(nameInput);
        row.appendChild(familyInput);
        listDiv.appendChild(row);
      });

      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function addNameField() {
      if (INITIAL_PEOPLE.length >= MAX_PARTICIPANTS) { alert('Maximum 100 participants allowed'); return; }
      const listDiv = document.getElementById('nameList');
      const row = document.createElement('div');
      row.className = 'participant-row';

      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.placeholder = 'New Name';
      nameInput.className = 'participant-name';

      const familyInput = document.createElement('input');
      familyInput.type = 'text';
      familyInput.placeholder = 'Family (optional)';
      familyInput.className = 'participant-family';

      row.appendChild(nameInput);
      row.appendChild(familyInput);
      listDiv.appendChild(row);

      INITIAL_PEOPLE.push('');
    }

    function saveNames() {
      const nameInputs = document.querySelectorAll('.participant-name');
      const familyInputs = document.querySelectorAll('.participant-family');
      const newNames = [];
      families = {};

      nameInputs.forEach((input, i) => {
        const name = input.value.trim();
        const family = familyInputs[i].value.trim();
        if (name !== '') {
          newNames.push(name);
          if (family) families[name] = family;
        }
      });

      if (newNames.length === 0) { alert('You must have at least one participant'); return; }
      INITIAL_PEOPLE.length = 0;
      INITIAL_PEOPLE.push(...newNames);
      initAssignments();
      document.getElementById('adminMsg').textContent = 'Names and families updated and assignments re-randomized!';
      document.getElementById('adminPanel').style.display = 'none';
    }

    document.getElementById('addNameBtn').onclick = addNameField;
    document.getElementById('saveNamesBtn').onclick = saveNames;

    window.addEventListener('DOMContentLoaded', () => {
      initAssignments();
      // Snow effect
      const snowflakeCount = 50;
      for (let i = 0; i < snowflakeCount; i++) {
        const flake = document.createElement('div');
        flake.classList.add('snowflake');
        flake.textContent = '❄';
        flake.style.left = Math.random() * 100 + 'vw';
        flake.style.fontSize = Math.random() * 24 + 12 + 'px';
        flake.style.animationDuration = (Math.random() * 10 + 5) + 's';
        flake.style.opacity = Math.random();
        document.body.appendChild(flake);
      }
    });
  </script>
</body>
</html>
