<script>
document.addEventListener("DOMContentLoaded", () => {

  const INITIAL_PEOPLE = ["Rob","Tilly","Sarah","Harry","Dan","Kelly","Neve","Erin"];
  let assignments = {};
  const usedDrawers = new Set();
  const MAX_PARTICIPANTS = 100;
  let families = {};

  const resultBox = document.getElementById('result');
  const drawerInput = document.getElementById('drawerName');
  const resetBtn = document.getElementById('resetBtn');

  function normalizeName(s) { return s.trim().toLowerCase(); }

  function shuffle(arr) {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function generateDerangement(names) {
    const maxAttempts = 1000;
    for (let attempt = 0; attempt < maxAttempts; attempt++) {
      const receivers = shuffle(names);
      let valid = true;
      for (let i = 0; i < names.length; i++) {
        const giver = names[i];
        const receiver = receivers[i];
        if (normalizeName(giver) === normalizeName(receiver) ||
            (families[giver] && families[giver] === families[receiver])) {
          valid = false;
          break;
        }
      }
      if (valid) return receivers;
    }
    return names.map((n,i) => names[(i+1)%names.length]);
  }

  function initAssignments() {
    const saved = localStorage.getItem("secretSantaAssignments");
    const savedFamilies = localStorage.getItem("secretSantaFamilies");
    const savedPeople = localStorage.getItem("secretSantaPeople");

    if (saved && savedFamilies && savedPeople) {
      assignments = JSON.parse(saved);
      families = JSON.parse(savedFamilies);
      INITIAL_PEOPLE.length = 0;
      INITIAL_PEOPLE.push(...JSON.parse(savedPeople));
      return;
    }

    const receivers = generateDerangement(INITIAL_PEOPLE);
    assignments = {};
    for (let i = 0; i < INITIAL_PEOPLE.length; i++) {
      assignments[normalizeName(INITIAL_PEOPLE[i])] = receivers[i];
    }

    saveAllData();
  }

  function saveAllData() {
    localStorage.setItem("secretSantaAssignments", JSON.stringify(assignments));
    localStorage.setItem("secretSantaFamilies", JSON.stringify(families));
    localStorage.setItem("secretSantaPeople", JSON.stringify(INITIAL_PEOPLE));
  }

  function showMessage(msg, isError=false) {
    if (!resultBox) return;
    resultBox.textContent = msg;
    resultBox.style.borderLeft = isError ? '6px solid #f44336' : '6px solid #4CAF50';
    resultBox.classList.add('show');
  }

  function drawName() {
    let drawer = drawerInput.value.trim();
    if (!drawer) { showMessage('Please enter your name.', true); return; }

    const drawerNorm = normalizeName(drawer);

    if (drawerNorm === 'admin') { showAdminPanel(); return; }

    if (drawerNorm === 'log') {
      let logText = 'Secret Santa Assignments:\n';
      for (const [giver, recipient] of Object.entries(assignments)) {
        logText += `${giver} → ${recipient}\n`;
      }
      showMessage(logText);
      return;
    }

    if (drawerNorm === 'cabbage' && resetBtn) resetBtn.style.display = 'block';

    const participantNorms = INITIAL_PEOPLE.map(p => normalizeName(p));
    if (!participantNorms.includes(drawerNorm)) {
      showMessage('Name not recognized.', true);
      return;
    }

    if (usedDrawers.has(drawerNorm)) {
      showMessage('You have already drawn.', true);
      return;
    }

    const recipient = assignments[drawerNorm];
    usedDrawers.add(drawerNorm);
    showMessage(`Hi ${drawer}, you will give a gift to: ${recipient}`);
  }

  function resetAll() {
    assignments = {};
    usedDrawers.clear();
    drawerInput.value = '';
    resultBox.classList.remove('show');
    resultBox.textContent = '';
    resultBox.style.borderLeft = '';
    resetBtn.style.display = 'none';

    localStorage.clear();

    initAssignments();
  }

  function showAdminPanel() {
    const panel = document.getElementById('adminPanel');
    panel.style.display = 'flex';

    const listDiv = document.getElementById('nameList');
    listDiv.innerHTML = '';

    INITIAL_PEOPLE.forEach((name, i) => {
      const row = document.createElement('div');
      row.className = 'participant-row';

      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = name;
      nameInput.className = 'participant-name';

      const familyInput = document.createElement('input');
      familyInput.type = 'text';
      familyInput.placeholder = 'Family (optional)';
      familyInput.className = 'participant-family';
      familyInput.value = families[name] || '';

      row.appendChild(nameInput);
      row.appendChild(familyInput);
      listDiv.appendChild(row);
    });

    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function addNameField() {
    if (INITIAL_PEOPLE.length >= MAX_PARTICIPANTS) {
      alert('Maximum 100 participants allowed');
      return;
    }
    const listDiv = document.getElementById('nameList');
    const row = document.createElement('div');
    row.className = 'participant-row';

    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.placeholder = 'New Name';
    nameInput.className = 'participant-name';

    const familyInput = document.createElement('input');
    familyInput.type = 'text';
    familyInput.placeholder = 'Family (optional)';
    familyInput.className = 'participant-family';

    row.appendChild(nameInput);
    row.appendChild(familyInput);
    listDiv.appendChild(row);

    INITIAL_PEOPLE.push('');
  }

  function saveNames() {
    const nameInputs = document.querySelectorAll('.participant-name');
    const familyInputs = document.querySelectorAll('.participant-family');

    const newNames = [];
    families = {};

    nameInputs.forEach((input, i) => {
      const name = input.value.trim();
      const fam = familyInputs[i].value.trim();
      if (name !== '') {
        newNames.push(name);
        if (fam) families[name] = fam;
      }
    });

    if (newNames.length === 0) {
      alert('You must have at least one participant');
      return;
    }

    INITIAL_PEOPLE.length = 0;
    INITIAL_PEOPLE.push(...newNames);

    initAssignments();
    saveAllData();

    document.getElementById('adminPanel').style.display = 'none';
  }

  initAssignments();

  document.getElementById('addNameBtn').onclick = addNameField;
  document.getElementById('saveNamesBtn').onclick = saveNames;
  document.getElementById('drawBtn').onclick = drawName;
  resetBtn.onclick = resetAll;

  // Snow effect
  const snowflakeCount = 50;
  for (let i = 0; i < snowflakeCount; i++) {
    const flake = document.createElement('div');
    flake.classList.add('snowflake');
    flake.textContent = '❄';
    flake.style.left = Math.random() * 100 + 'vw';
    flake.style.fontSize = Math.random() * 24 + 12 + 'px';
    flake.style.animationDuration = (Math.random() * 10 + 5) + 's';
    flake.style.opacity = Math.random();
    document.body.appendChild(flake);
  }

}); // END DOMContentLoaded
</script>
